<div title="业绩分析" class="easyui-panel">
    <div fit="true">
        <div data-options="region:'north',split:false" style="height: 30px;padding:6px;" border="false">
        <!--高级查询部分-->
        <table border="0" cellspacing="0" cellpadding="0" width="100%" id="tool_{{random_key}}">
            <tr>
                <th><label id="lab_txt_{{random_key}}">时间:</label></th>
                <td>
                    <label id="item_time_{{random_key}}">
                      <input class="easyui-datebox" type="text" id="datebox_time_{{random_key}}"/>
                    </label>
                    <label id="item_year_{{random_key}}" style="display:none">
                      <select class="easyui-combobox" id="combobox_year_{{random_key}}">
                          <option selected="selected" value=''>--年--</option>
                          <option value='2013'>2013</option>
                          <option value='2014'>2014</option>
                      </select>
                    </lable>
                    <label id="item_month_{{random_key}}" style="display:none">
                      <select class="easyui-combobox" id="combobox_month_{{random_key}}">
                          <option selected="selected" value=''>--月--</option>
                          {% for i in range(1, 12)%}
                          <option value='{{i}}'>{% if i<10 %}0{{i}}{%else%}{{i}}{%endif%}</option>
                          {% endfor%}
                      </select>
                    </label>
                </td>
                <th>通道:</th>
                <td>
                    <select id="channel_id_{{random_key}}" class="easyui-combobox">
                        <option selected="selected" value=''>--请选择--</option>
                        {%for channel in channels%}
                        <option value="{{channel.id}}">{{channel.cha_name}}</option>
                        {%endfor%}
                    </select>
                </td>
                <th>合作方:</th>
                <td>
                    <select id="sp_id_{{random_key}}" class="easyui-combobox">
                        <option selected="selected" value=''>--请选择--</option>
                        {% for sp_info in sp_info_list %}
                        <option value="{{sp_info.id}}">[{{sp_info.id}}]{{sp_info.name}}</option>
                        {% endfor %}
                    </select>
                </td>
                <th>筛选方式:</th>
                <td>
                    <label for="_radio_search1_{{random_key}}"><input type="radio" value="time" id="_radio_search1_{{random_key}}" name="order_type" checked="checked"/>时段</label>
                    <label for="_radio_search2_{{random_key}}"><input type="radio" value="month" id="_radio_search2_{{random_key}}" name="order_type"/>日段</label>
                    <label for="_radio_search3_{{random_key}}"><input type="radio" value="year" id="_radio_search3_{{random_key}}" name="order_type"/>月段</label>
                </td>
                <td align="right">
                    <a class="easyui-linkbutton" data-options="iconCls:'icon-search'" src="javascript:;" onclick="operator_exploits_manange.queryData()" plain="true">查询</a>
                </td>
            </tr>
        </table>
        </div>
        <div data-options="region:'center',split:false"  border="false">
             <div id="graphic" class="span8">
                <div id="operator_exploits_chart" class="main" style="height:400px; width: 98%"></div>
                <div>
            </div>
        </div>
    </div>
</div>
<script>
// 路径配置
require.config({
    paths:{
        'echarts' : 'http://echarts.baidu.com/build/echarts',
        'echarts/chart/bar' : 'http://echarts.baidu.com/build/echarts'
    }
});

// 使用
require(
    [
        'echarts',
        'echarts/chart/bar' // 使用柱状图就加载bar模块，按需加载
    ],
    function(ec) {
        // 基于准备好的dom，初始化echarts图表
        window.myExploitsChart = ec.init(document.getElementById('operator_exploits_chart'));
        window.Exploitsoption = {
            title : {
                text: '业绩分析',
                subtext: '{{regdate}}'
            },
            tooltip : {
                trigger: 'axis'
            },
            legend: {
                data:['转化率(%)','T-定制', 'T-转化率(%)', '分成比(%)', 'Arpu值']
            },
            toolbox: {
                show : true,
                feature : {
                    mark : {show: true},
                    dataView : {show: true, readOnly: false},
                    magicType : {show: false},
                    restore : {show: true},
                    saveAsImage : {show: true}
                }
            },
            calculable : true,
            xAxis : [
                {
                    type : 'category',
                    boundaryGap : false,
                    data : ['0-1','1-2','2-3','3-4','4-5','5-6','6-7', '7-8','8-9', '9-10', '10-11', '11-12', '12-13', '13-14', '14-15', '15-16', '16-17', '18-19', '19-20', '20-21', '21-22', '22-23', '23-24']
                }
            ],
            yAxis : [
                {
                    type : 'value',
                    axisLabel : {
                        formatter: '{value} %'
                    }
                }
            ],
            series : [
                {
                    name:'转化率(%)',
                    type:'line',
                    data:{{conversion_rate|safe}},
                    markPoint : {
                        data : [
                            {type : 'max', name: '最大值'},
                            {type : 'min', name: '最小值'}
                        ]
                    }
                },
                {
                    name:'T-定制',
                    type:'line',
                    data:{{t_customize|safe}},
                    markPoint : {
                        data : [
                            {type : 'max', name: '最大值'},
                            {type : 'min', name: '最小值'}
                        ]
                    }
                },
                {
                    name:'T-转化率(%)',
                    type:'line',
                    data:{{t_conversion_rate|safe}},
                    markPoint : {
                        data : [
                            {type : 'max', name: '最大值'},
                            {type : 'min', name: '最小值'}
                        ]
                    }
                },
                {
                    name:'分成比(%)',
                    type:'line',
                    data: {{into_rate|safe}},
                    markPoint : {
                        data : [
                            {type : 'max', name: '最大值'},
                            {type : 'min', name: '最小值'}
                        ]
                    }
                },
                {
                    name:'Arpu值',
                    type:'line',
                    data: {{arpu|safe}},
                    markPoint : {
                        data : [
                            {type : 'max', name: '最大值'},
                            {type : 'min', name: '最小值'}
                        ]
                    }
                }
            ]
        };

        // 为echarts对象加载数据
        window.myExploitsChart.setOption(window.Exploitsoption);
    }
);

var operator_exploits_manange = {
    url: '',
    datagrid: $('#operator_exploits_list_dg'),
    formatStatus: function(val, row) {
        if (val) {
            return '<span class="icon icon-ok">&nbsp;</span>已开通'
        }else {
            return '<lable style="color:red"><span class="icon icon-error">&nbsp;</span>已暂停</label>'
        }
    },
    formatterDate: function(val, row) {
        var date = new Date(val);
        return date.getFullYear() + '年' + (date.getMonth() + 1) + '月' + date.getDate()+'日 '+date.getUTCHours()+':'+date.getUTCMinutes()+':'+date.getSeconds();
    },
    formatCommand: function(val, row) {
        val = parseInt(val);
        switch(val){
            case 1:
                return '模糊';
            case 2:
                return '双精确';
        }
    },
    refresh: function(data){
            window.myExploitsChart.showLoading();
            require(
            [
                'echarts',
                'echarts/chart/bar' // 使用柱状图就加载bar模块，按需加载
            ],
            function(ec) {
                // 基于准备好的dom，初始化echarts图表
                window.myExploitsChart = ec.init(document.getElementById('operator_exploits_chart'));
                window.Exploitsoption = {
                    title : {
                        text: '业绩分析',
                        subtext: data.title
                    },
                    tooltip : {
                        trigger: 'axis'
                    },
                    legend: {
                        data:['转化率(%)','T-定制', 'T-转化率(%)', '分成比(%)', 'Arpu值']
                    },
                    toolbox: {
                        show : true,
                        feature : {
                            mark : {show: true},
                            dataView : {show: true, readOnly: false},
                            magicType : {show: false},
                            restore : {show: true},
                            saveAsImage : {show: true}
                        }
                    },
                    calculable : true,
                    xAxis : [
                        {
                            type : 'category',
                            boundaryGap : false,
                            data : data.xAxis
                        }
                    ],
                    yAxis : [
                        {
                            type : 'value',
                            axisLabel : {
                                formatter: '{value} %'
                            }
                        }
                    ],
                    series : [
                        {
                            name:'转化率(%)',
                            type:'line',
                            data:data.conversion_rate,
                            markPoint : {
                                data : [
                                    {type : 'max', name: '最大值'},
                                    {type : 'min', name: '最小值'}
                                ]
                            }
                        },
                        {
                            name:'T-定制',
                            type:'line',
                            data:data.t_customize,
                            markPoint : {
                                data : [
                                    {type : 'max', name: '最大值'},
                                    {type : 'min', name: '最小值'}
                                ]
                            }
                        },
                        {
                            name:'T-转化率(%)',
                            type:'line',
                            data:data.t_conversion_rate,
                            markPoint : {
                                data : [
                                    {type : 'max', name: '最大值'},
                                    {type : 'min', name: '最小值'}
                                ]
                            }
                        },
                        {
                            name:'分成比(%)',
                            type:'line',
                            data: data.into_rate,
                            markPoint : {
                                data : [
                                    {type : 'max', name: '最大值'},
                                    {type : 'min', name: '最小值'}
                                ]
                            }
                        },
                        {
                            name:'Arpu值',
                            type:'line',
                            data: data.arpu,
                            markPoint : {
                                data : [
                                    {type : 'max', name: '最大值'},
                                    {type : 'min', name: '最小值'}
                                ]
                            }
                        }
                    ]
                };
                // 为echarts对象加载数据
                window.myExploitsChart.setOption(window.Exploitsoption);
            });
    },
    queryData: function() {

        var channel = $("#channel_id_{{random_key}}").combobox('getValue');
        var sp = $("#sp_id_{{random_key}}").combobox('getValue');
        var toolEL = $("#tool_{{random_key}}");

        var req_data = {'channel_id': channel,
           'sp_id': sp,
           'order_type': toolEL.find('input:radio[name="order_type"]:checked').val()
        };
        if (req_data.order_type == 'time') {
          req_data['time'] = $("#datebox_time_{{random_key}}").datetimebox('getValue');
        };
        if(req_data.order_type == 'month') {
          req_data['month'] = $("#combobox_month_{{random_key}}").combobox('getValue');
          req_data['year'] =  $("#combobox_year_{{random_key}}").combobox('getValue');
        };

        if(req_data.order_type == 'year') {
          req_data['year'] =  $("#combobox_year_{{random_key}}").combobox('getValue');
        };

        $.ajax({
          url: '/operator/exploits/',
          data: req_data,
          dataType: 'json',
          type: 'POST',
          success: function(resp, status) {
                if (resp.ok) {
                    operator_exploits_manange.refresh(resp.data);
                }
            }
        });
    },
    eventBind: function() {
        var toolEL = $("#tool_{{random_key}}");
        var order_type = toolEL.find('input[name="order_type"]');
        var item_time = $("#item_time_{{random_key}}");
        var item_month = $("#item_month_{{random_key}}");
        var item_year = $("#item_year_{{random_key}}");
        var lab_text = $("#lab_txt_{{random_key}}");



        order_type.on('click', function() {
          var is_checked = $(this).is(":checked");
          if (is_checked) {
            item_time.hide();
            item_month.hide();
            if($(this).val() == 'time') {
              item_year.hide();
              lab_text.text('时间：');
            }else{
              _text = $(this).val() == 'month' ? '月份：' : '年份：';
              lab_text.text(_text);
              item_year.show();
            }
            $("#item_"+$(this).val()+"_{{random_key}}").show();
          }
        });
    }
};
operator_exploits_manange.eventBind();
</script>
